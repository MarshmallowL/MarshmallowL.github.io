<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>test</title>
    <link href="/2022/04/20/2022/test/"/>
    <url>/2022/04/20/2022/test/</url>
    
    <content type="html"><![CDATA[<p>#这是一个测试博客</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>rsync同步备份</title>
    <link href="/2020/03/26/2020/rsync%E5%90%8C%E6%AD%A5%E6%96%87%E4%BB%B6%E5%A4%B9/"/>
    <url>/2020/03/26/2020/rsync%E5%90%8C%E6%AD%A5%E6%96%87%E4%BB%B6%E5%A4%B9/</url>
    
    <content type="html"><![CDATA[<h2 id="文章来源"><a href="#文章来源" class="headerlink" title="文章来源"></a>文章来源</h2><ul><li><a href="https://www.cnblogs.com/regit/p/8074221.html">rsync文件同步详解</a></li><li><a href="http://blog.chinaunix.net/uid-11209572-id-3489986.html">linux配置rsync服务端</a></li></ul><h2 id="rsync简介"><a href="#rsync简介" class="headerlink" title="rsync简介"></a>rsync简介</h2><blockquote><p>rsync是linux系统下的数据镜像备份工具。使用快速增量备份工具Remote Sync可以远程同步，支持本地复制，或者与其他SSH、rsync主机同步。</p></blockquote><h2 id="安装rsync-centos默认安装了"><a href="#安装rsync-centos默认安装了" class="headerlink" title="安装rsync(centos默认安装了)"></a>安装rsync(centos默认安装了)</h2><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">yum -y install rsync<br><span class="hljs-meta">#</span><span class="bash">查看版本</span><br>rsync --version<br></code></pre></div></td></tr></table></figure><h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><ul><li><p>PC1: ==rsync服务端==，需要被备份的服务器，IP:192.168.80.14, 备份目录 /common</p></li><li><p>PC2: ==rsync客户端==，备份服务器，用于存放备份文件（目录为/test），IP:192.168.80.15</p></li></ul><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ol><li>首先登录PC1，编辑配置文件 <code>vim /etc/rsyncd.conf</code>, 配置文件如下</li></ol><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">设置服务器信息提示文件，在该文件中编写提示信息</span><br>motd file = /etc/rsyncd.motd<br><span class="hljs-meta">#</span><span class="bash">开启rsync数据传输日志功能</span><br>transfer logging = yes<br><span class="hljs-meta">#</span><span class="bash">设置日志文件名，可通过<span class="hljs-built_in">log</span> format参数设置日志格式</span><br>log file = /var/log/rsyncd.log<br><span class="hljs-meta">#</span><span class="bash">设置rsync进程号保存文件名称</span><br>pid file = /var/run/rsyncd.log<br><span class="hljs-meta">#</span><span class="bash">设置锁文件名称</span><br>lock file = /var/run/rsync.lock<br><span class="hljs-meta">#</span><span class="bash">设置服务器监听的端口号，默认是873</span><br>port = 873<br><span class="hljs-meta">#</span><span class="bash">设置本服务器所监听网卡接口的ip地址</span><br>address = 192.168.80.14<br><span class="hljs-meta">#</span><span class="bash">设置进行数据传输时所使用的帐户名或ID号,默认nobody</span><br>uid = nobody<br><span class="hljs-meta">#</span><span class="bash">设置进行数据传输时所使用的组名或GID号,默认nobody</span><br>gid = nobody<br><span class="hljs-meta">#</span><span class="bash">若为yes, rsync会首先进行chroot设置，将根映射在下面的path参数路径下，对客户端而言，系统的根就是path参数指定的路径。但这样做需要root权限，并且在同步符号连接资料时只会同步名称，不会同步内容。</span><br>use chroot = no<br><span class="hljs-meta">#</span><span class="bash">是否允许客户端上传数据，yes表示不允许</span><br>read only = yes<br><span class="hljs-meta">#</span><span class="bash">设置并发连接数，0表示无限制</span><br>max connections = 10<br><span class="hljs-meta">#</span><span class="bash">自定义模块名，rsync通过模块定义同步的目录，可定义多个</span><br>[common]<br><span class="hljs-meta">#</span><span class="bash">定义注释说明字串</span><br>comment = backup ftp<br><span class="hljs-meta">#</span><span class="bash">同步目录的真实路径通过path指定，该路径是指服务端需要备份的路径</span><br>path = /common<br><span class="hljs-meta"> #</span><span class="bash">忽略一些IO错误</span><br>ignore errors<br><span class="hljs-meta">#</span><span class="bash">exclude = <span class="hljs-built_in">test</span>/    <span class="hljs-comment">#exclude指定common目录下某个目录可以不同步数据</span></span><br><br><span class="hljs-meta">#</span><span class="bash">设置允许连接服务器的账户，此账户可以是系统中不存在的用户</span><br>auth users = tom,jerry<br><span class="hljs-meta">#</span><span class="bash">密码验证文件名，该文件权限要求为只读，建议为600，仅在设置auth users后有效</span><br>secrets file = /etc/rsyncd.secrets<br><span class="hljs-meta">#</span><span class="bash">设置哪些主机可以同步数据，多ip和网段之间使用空格分隔</span><br>hosts allow = 192.168.80.0/255.255.255.0<br><span class="hljs-meta">#</span><span class="bash">除了hosts allow定义的主机外，拒绝其他所有</span><br>hosts deny = *<br><span class="hljs-meta"> #</span><span class="bash">客户端请求显示模块列表时，本模块名称是否显示，默认为<span class="hljs-literal">true</span></span><br>list = false<br></code></pre></div></td></tr></table></figure><ol start="2"><li>创建密码文件，PC1和PC2都需要操作</li></ol><p>==注意！客户端只需写入密码即可！！==</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">echo &quot;tom:123&quot; &gt; /etc/rsyncd.secrets<br>echo &quot;jerry:123&quot; &gt;&gt; /etc/rsyncd.secrets<br>chmod 600 /etc/rsyncd.secrets<br>echo &quot;welcome to access&quot; &gt; /etc/rsyncd.motd  #此项客户端不需要做<br>rsync --daemon    # --daemon表示后台执行，客户端开启rsync不需要--daemon选项<br>echo &quot;/usr/bin/rsync --daemon&quot; &gt;&gt; /etc/rc.local    #开机启动rsync服务<br>firewall-cmd --permanent --add-port=873/tcp    #添加防火墙规则，允许873端口的数据访问<br></code></pre></div></td></tr></table></figure><ol start="3"><li>查看rsync和se-linux相关的设置（==服务端设置==）</li></ol><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">getsebool -a | grep rsync<br><span class="hljs-meta">#</span><span class="bash">如果rsync_export_all_ro是off,将其修改为on</span><br>setsebool -P rsync_export_all_ro on<br></code></pre></div></td></tr></table></figure><ol start="4"><li>rsync语法格式（==客户端执行==）</li></ol><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell">rsync -vzrtopg --progress tom@192.168.80.14::common /test     #通common模块指定的/common目录下的文件拷贝到本客户端的/test目录<br><span class="hljs-meta">#</span><span class="bash">参数说明</span><br>v:显示详细信息<br>z：传输过程中对数据进行压缩<br>r：递归<br>t：保留修改时间属性<br>o：保留文件所有者属性<br>p：保留文件权限属性<br>g：保留文件所属组属性<br>a：归档模式，主要保留文件属性，等同于-rlptgoD<br>--progress：显示数据传输的进度信息<br>--password-file=FILE：指定密码文件，将密码写入文件，实现非交互式数据同步，这个文件名也需要修改权限为600<br>--delete：删除那些仅在目标路径中存在的文件（源路径中不存在），在脚本中的数据同步经常加上此参数<br>--list-only：仅列出服务器模块列表，需要rsync服务器设置list=true<br></code></pre></div></td></tr></table></figure><ol start="5"><li>shell脚本（==客户端执行==）</li></ol><p><code>touch /backup-ftp.sh</code>  新建脚本</p><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><br>export PATH=/bin:/usr/bin:/usr/local/bin<br>SRC=common<br>DEST=/test/<br>server=192.168.80.14<br>user=tom<br>passfile=/etc/rsyncd.secrets<br><span class="hljs-meta">#</span><span class="bash"><span class="hljs-keyword">if</span> the DEST directory not found, <span class="hljs-keyword">then</span> create one</span><br>[ ! -d $DEST ] &amp;&amp; mkdir $DEST<br>[ ! -e $passfile ] &amp;&amp; exit 2<br>rsync -az --delete --password-file=$passfile $&#123;user&#125;@$&#123;server&#125;::$SRC $DEST<br><br></code></pre></div></td></tr></table></figure><ol start="6"><li>加入定时任务</li></ol><figure class="highlight shell"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">进入定时任务</span><br>crontab -e <br><span class="hljs-meta">#</span><span class="bash">每隔6小时备份一次</span><br>* */6 * * * sh /backup-ftp.sh<br></code></pre></div></td></tr></table></figure><p>以上为rsync备份基本流程，包括踩的一些坑，待有其他坑再补上</p>]]></content>
    
    
    <categories>
      
      <category>工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>util</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
